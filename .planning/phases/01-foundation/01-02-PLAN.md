---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/game/systems/InputSystem.js
  - src/game/systems/RenderPipeline.js
  - src/game/entities/EntityManager.js
  - src/game/entities/Entity.js
  - src/game/engine/GameEngine.js
  - src/pages/GamePage.jsx
autonomous: false

must_haves:
  truths:
    - "Drawing with mouse on the Canvas produces a visible glowing trail in real time"
    - "Drawing with touch on the Canvas produces the same visible trail"
    - "Releasing the mouse/touch clears the trail after a short fade"
    - "Test entities (circles) spawn on screen and move smoothly using delta time"
    - "Test entities move at the same speed regardless of monitor refresh rate (60Hz vs 120Hz)"
    - "The drawing trail and entity rendering coexist without visual conflicts"
  artifacts:
    - path: "src/game/systems/InputSystem.js"
      provides: "Mouse/touch input capture with drawing point collection"
      exports: ["InputSystem"]
      min_lines: 60
    - path: "src/game/entities/EntityManager.js"
      provides: "Create, update, remove, and query game entities"
      exports: ["EntityManager"]
      min_lines: 40
    - path: "src/game/entities/Entity.js"
      provides: "Base entity with position, velocity, size, type, active flag"
      exports: ["Entity"]
    - path: "src/game/systems/RenderPipeline.js"
      provides: "Ordered rendering of background, entities, drawing trail, UI"
      exports: ["RenderPipeline"]
  key_links:
    - from: "src/game/systems/InputSystem.js"
      to: "canvas element"
      via: "addEventListener for mouse/touch events"
      pattern: "addEventListener.*(mousedown|touchstart)"
    - from: "src/game/engine/GameEngine.js"
      to: "src/game/systems/InputSystem.js"
      via: "addSystem() in init"
      pattern: "addSystem.*InputSystem|new InputSystem"
    - from: "src/game/engine/GameEngine.js"
      to: "src/game/entities/EntityManager.js"
      via: "engine owns entityManager"
      pattern: "this\\.entityManager|new EntityManager"
    - from: "src/game/systems/RenderPipeline.js"
      to: "src/game/systems/InputSystem.js"
      via: "renders drawing trail from input points"
      pattern: "drawingPoints|trailPoints|inputSystem"
---

<objective>
Build the input capture system for mouse/touch drawing with a visible glowing trail, and the entity management system with test entities that move using delta time.

Purpose: The drawing trail is the core interaction for the entire game -- every spell starts with a drawn gesture. The entity manager is the container for all future game objects (enemies, projectiles, particles). Both must work with the fixed timestep loop from Plan 01.

Output: Drawing on the Canvas produces a visible glowing trail. Test entities spawn and move smoothly. The foundation is ready for gesture recognition (Phase 2) and combat entities (Phase 4).
</objective>

<execution_context>
@/Users/johnsong/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsong/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Input system with drawing trail and entity manager with test entities</name>
  <files>
    src/game/systems/InputSystem.js
    src/game/systems/RenderPipeline.js
    src/game/entities/Entity.js
    src/game/entities/EntityManager.js
    src/game/engine/GameEngine.js
    src/pages/GamePage.jsx
  </files>
  <action>
    1. Create src/game/entities/Entity.js -- Base entity class:
    ```
    class Entity {
      constructor({ x, y, vx = 0, vy = 0, size = 10, type = 'generic', color = '#4a8f8f' })
      id -- unique string (use crypto.randomUUID() or incrementing counter)
      x, y -- position
      vx, vy -- velocity (pixels per second, NOT per frame)
      size -- radius for circles
      type -- string identifier ('test', 'enemy', 'projectile', etc.)
      color -- fill color
      active -- boolean, false means pending removal

      update(dt) -- this.x += this.vx * dt; this.y += this.vy * dt (dt is in seconds)
      render(ctx, interpolation) -- draw a filled circle at position with a subtle glow (shadowBlur)
      destroy() -- sets active = false
    }
    ```
    Velocity is in pixels/SECOND. The update receives dt in seconds (already divided by 1000 in the game loop). This ensures frame-rate independence.

    2. Create src/game/entities/EntityManager.js -- Manages all game entities:
    ```
    class EntityManager {
      entities = [] -- array of Entity instances

      add(entity) -- pushes entity, returns the entity
      remove(id) -- sets entity.active = false
      update(dt) -- calls entity.update(dt) for all active entities, then removes inactive entities
      render(ctx, interpolation) -- calls entity.render(ctx, interpolation) for all active entities
      getByType(type) -- returns array of entities matching type
      getAll() -- returns all active entities
      clear() -- removes all entities
      get count() -- returns active entity count
    }
    ```
    The remove step happens AFTER the update loop (not during) to avoid mutation-during-iteration bugs.

    3. Create src/game/systems/InputSystem.js -- Captures mouse and touch input:
    ```
    class InputSystem {
      constructor(canvas) -- stores canvas ref
      isDrawing = false
      currentPoints = [] -- array of {x, y, timestamp} during active drawing
      trailPoints = [] -- smoothed points for rendering the trail

      init() -- adds event listeners to canvas:
        Mouse: mousedown (startDrawing), mousemove (continueDrawing), mouseup (stopDrawing)
        Touch: touchstart (startDrawing), touchmove (continueDrawing), touchend (stopDrawing)
        Touch events must call e.preventDefault() to prevent scrolling
        Use canvas.getBoundingClientRect() to convert page coords to canvas coords

      startDrawing(x, y) -- sets isDrawing = true, clears currentPoints, pushes first point
      continueDrawing(x, y) -- if isDrawing, pushes point to currentPoints and trailPoints
      stopDrawing() -- sets isDrawing = false. Keep trailPoints for fade-out rendering, but mark them for decay.

      update(dt) -- fade out old trail points: reduce their alpha. Remove fully faded points.
        Each trail point gets an alpha property (starts at 1.0).
        When not drawing, decay alpha by dt * 3 (fades over ~0.3 seconds).
        Remove points where alpha <= 0.

      render(ctx) -- draw the trail:
        Draw connected line segments through trailPoints with:
        - lineWidth: 3
        - strokeStyle: teal (#4a8f8f) with alpha from each point
        - lineCap: 'round', lineJoin: 'round'
        - Glow effect: ctx.shadowBlur = 15, ctx.shadowColor = 'rgba(126, 184, 218, 0.6)'
        Draw as a series of short segments (point to next point) so each segment can have its own alpha.
        Reset shadowBlur after drawing to avoid contaminating other renders.

      getPoints() -- returns copy of currentPoints (for gesture recognition in Phase 2)

      destroy() -- removes all event listeners from canvas
    ```

    4. Create src/game/systems/RenderPipeline.js -- Controls render order:
    ```
    class RenderPipeline {
      constructor(ctx, width, height)

      render(ctx, entityManager, inputSystem, interpolation) {
        // Layer 1: Background (dark fill -- already cleared by engine)
        // Layer 2: Game entities (entityManager.render)
        // Layer 3: Drawing trail (inputSystem.render)
        // Layer 4: UI overlays (future: HUD, score, etc.)
      }
    }
    ```
    This ensures trail renders ABOVE entities so the player always sees their drawing.

    5. Update src/game/engine/GameEngine.js:
    - Import and create EntityManager, InputSystem, RenderPipeline in init()
    - Store as this.entityManager, this.inputSystem, this.renderPipeline
    - In init(), after creating systems, spawn 5 test entities:
      - Random positions within canvas bounds
      - Random velocities between -50 and 50 pixels/second
      - Random sizes between 8 and 20
      - Colors alternating between teal (#4a8f8f), gold (#f4e8c1), and blue (#7eb8da)
      - Type: 'test'
    - In update(dt): call this.inputSystem.update(dt), then this.entityManager.update(dt). Add boundary wrapping: if entity goes off-screen, wrap to opposite side.
    - In render(interpolation): clear canvas with #0a0a12, then call this.renderPipeline.render() passing ctx, entityManager, inputSystem, interpolation. Keep the FPS counter rendering after the pipeline.
    - Remove the old test sine-wave circle from Plan 01 (replaced by entity system).
    - In destroy(): call this.inputSystem.destroy() to clean up event listeners.

    6. Update src/pages/GamePage.jsx:
    - Add touch-action: none CSS on the canvas to prevent browser touch gestures
    - Add a small entity count display next to FPS (e.g., "Entities: 5") reading from entityManager via Zustand or direct display

    CRITICAL PATTERNS:
    - Touch events MUST call preventDefault() or the browser will try to scroll/zoom
    - Trail points must use canvas-relative coordinates (subtract getBoundingClientRect().left/top)
    - Entity velocity is pixels per SECOND, multiplied by dt (in seconds) in update
    - InputSystem must clean up ALL event listeners in destroy() to prevent leaks
  </action>
  <verify>
    Run `npm run dev` and test:
    1. Navigate to /game -- 5 colored circles move smoothly across screen, wrapping at edges
    2. Click and drag on canvas -- a glowing teal trail follows the mouse in real time with no perceptible lag
    3. Release mouse -- trail fades out over ~0.3 seconds
    4. On a touchscreen device (or Chrome DevTools device emulation): touch and drag produces the same trail
    5. Trail renders above the moving circles (drawing over them, not behind)
    6. Navigate to / and back to /game -- no errors, entities respawn, input works again
    7. FPS stays at ~60 during drawing with multiple entities
    8. Open DevTools console -- no errors, no event listener leak warnings
    9. (Critical) Test frame-rate independence: Open DevTools Performance tab, throttle CPU to 4x slowdown. Entities should move at the same logical speed (same distance over same clock time) even though frame rate drops. This proves velocity * deltaTime works correctly.
  </verify>
  <done>
    Drawing on the Canvas produces a glowing teal trail that follows mouse/touch input in real time. 5 test entities move smoothly using delta time. Trail fades on release. Navigation cleanup works. The input system captures points that can be consumed by gesture recognition (Phase 2). The entity manager can be used for enemies, projectiles, and particles (Phase 4+).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 1 Foundation: Vite project scaffold, React main menu with dark mystical aesthetic, Canvas game screen with fixed timestep game loop, mouse/touch drawing trail with glow effect, entity management with test entities, Zustand state bridge, and proper cleanup on navigation.
  </what-built>
  <how-to-verify>
    1. Open http://localhost:5173 in browser
    2. Verify main menu matches the dark mystical aesthetic:
       - "AETHOS" title in Cinzel Decorative font
       - "Fragments of the Void" subtitle
       - 5 menu items (Begin Journey, Archives, Sigils, Settings, Depart)
       - Floating particles in background
       - Custom gold cursor
       - Teal/gold/navy color palette
    3. Hover over "Begin Journey" -- confirm gold highlight, diamond indicator, subtitle appears
    4. Click "Begin Journey" -- should navigate to game screen
    5. On game screen:
       - Dark background with colored circles moving smoothly
       - FPS counter showing ~60
       - Click and drag to draw -- glowing teal trail appears
       - Release -- trail fades out
       - Drawing feels responsive with no lag
    6. Click "Back to Menu" -- returns to main menu
    7. Click "Begin Journey" again -- game loads cleanly, no doubled animations
    8. (Optional) Open DevTools, toggle to mobile device, test touch drawing
  </how-to-verify>
  <resume-signal>Type "approved" to proceed to Phase 2, or describe any visual/functional issues to fix.</resume-signal>
</task>

</tasks>

<verification>
1. Full main menu renders with existing dark mystical aesthetic at /
2. Canvas game screen at /game renders at 60 FPS
3. Mouse drawing produces visible glowing trail in real time
4. Touch drawing produces the same trail (tested via DevTools emulation)
5. Trail fades on release
6. 5 test entities move smoothly with delta-time-independent physics
7. Navigation between / and /game is clean (no leaks, no crashes, no stale state)
8. Zustand store gameState reflects navigation state
9. All event listeners cleaned up on unmount
</verification>

<success_criteria>
- FOUND-04: Mouse and touch input capture with visible drawing trail on Canvas
- FOUND-07: Entity management system with add/remove/update/render/query
- All Phase 1 success criteria from roadmap met:
  1. Main menu launches Canvas game screen at 60 FPS
  2. Drawing produces visible trail with no perceptible lag
  3. Navigation away and back does not leak frames or crash
  4. Game screen matches dark mystical aesthetic
  5. Game objects move at same speed regardless of refresh rate
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
