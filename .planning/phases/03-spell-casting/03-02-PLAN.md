---
phase: 03-spell-casting
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/game/entities/projectiles/QuickShotEntity.js
  - src/game/entities/projectiles/MagicMissileEntity.js
  - src/game/entities/projectiles/FireballEntity.js
  - src/game/entities/projectiles/FireballExplosion.js
  - src/game/systems/SpellCaster.js
  - src/game/systems/GestureUI.js
autonomous: false

must_haves:
  truths:
    - "Sloppy gestures produce visibly smaller and dimmer projectiles compared to perfect gestures"
    - "Perfect gestures produce full-size, bright projectiles with prominent glow"
    - "Accuracy feedback text ('Perfect!', 'Good', 'Sloppy') appears on screen after casting"
    - "Fireball projectiles trigger an expanding orange explosion ring when they expire"
    - "All three spell types are visually distinct from each other at a glance"
  artifacts:
    - path: "src/game/entities/projectiles/FireballExplosion.js"
      provides: "AoE expanding ring + inner glow VFX entity"
      exports: ["default (FireballExplosion)"]
    - path: "src/game/entities/projectiles/QuickShotEntity.js"
      provides: "Accuracy-scaled size and brightness rendering"
      contains: "damageModifier"
    - path: "src/game/entities/projectiles/MagicMissileEntity.js"
      provides: "Accuracy-scaled size and brightness rendering"
      contains: "damageModifier"
    - path: "src/game/entities/projectiles/FireballEntity.js"
      provides: "Accuracy-scaled rendering + explosion trigger on destroy"
      contains: "damageModifier"
  key_links:
    - from: "src/game/entities/projectiles/FireballEntity.js"
      to: "src/game/entities/projectiles/FireballExplosion.js"
      via: "Fireball destruction triggers explosion spawn"
      pattern: "FireballExplosion"
    - from: "src/game/systems/SpellCaster.js"
      to: "src/game/entities/projectiles/FireballExplosion.js"
      via: "SpellCaster handles explosion spawning when fireball expires"
      pattern: "FireballExplosion"
---

<objective>
Add accuracy-based visual scaling to all spell projectiles, create the Fireball explosion AoE effect, and verify the complete spell casting experience through user testing.

Purpose: Sloppy gestures must produce visibly weaker spells (Success Criteria #4). Without accuracy scaling, there's no gameplay consequence to drawing quality — the game would feel the same whether you draw a perfect circle or a wobbly mess. The Fireball explosion is the visual payoff for the most complex gesture (zigzag).

Output: Accuracy-scaled projectile visuals, FireballExplosion VFX entity, and user verification that spell casting feels responsive and satisfying.
</objective>

<execution_context>
@/Users/johnsong/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsong/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-spell-casting/03-RESEARCH.md
@.planning/phases/03-spell-casting/03-01-SUMMARY.md

# Source files from Plan 01:
@src/game/entities/projectiles/QuickShotEntity.js
@src/game/entities/projectiles/MagicMissileEntity.js
@src/game/entities/projectiles/FireballEntity.js
@src/game/systems/SpellCaster.js
@src/game/data/spellConfig.js
@src/game/systems/GestureUI.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add accuracy-based visual scaling and Fireball explosion</name>
  <files>
    src/game/entities/projectiles/QuickShotEntity.js
    src/game/entities/projectiles/MagicMissileEntity.js
    src/game/entities/projectiles/FireballEntity.js
    src/game/entities/projectiles/FireballExplosion.js
    src/game/systems/SpellCaster.js
    src/game/systems/GestureUI.js
  </files>
  <action>
    **1. Update all three projectile entities with accuracy-based visual scaling:**

    The `damageModifier` ranges from 0.5 (60% accuracy, sloppy) to 1.0 (100% accuracy, perfect). Scale these visual properties:

    **QuickShotEntity.js render():**
    - Size: `this.size * (0.7 + 0.3 * this.damageModifier)` — sloppy = 70% of base, perfect = 100%
    - Brightness (globalAlpha): `0.6 + 0.4 * this.damageModifier` — sloppy = 0.8 alpha, perfect = 1.0
    - Shadow glow: `shadowBlur = 6 + 6 * this.damageModifier` — sloppy = 9, perfect = 12
    - The visual difference between 0.5x and 1.0x damageModifier must be NOTICEABLE. A sloppy spell should look anemic. A perfect spell should look powerful.

    **MagicMissileEntity.js render():**
    - Same alpha/glow scaling as QuickShot
    - Ellipse size scales with damageModifier (both radii)
    - Add a small tail trail: render 2-3 smaller, fading circles behind the projectile along its movement vector. This makes Magic Missile visually distinct even at small sizes.

    **FireballEntity.js render():**
    - Same alpha/glow scaling pattern
    - Inner glow radius and alpha scale with damageModifier
    - A sloppy fireball should look like a dim ember; a perfect one like a blazing inferno
    - Add `this.onExpire` callback property (set to null by default). When `destroy()` is called due to lifetime expiry, call `this.onExpire?.(this.x, this.y, this.damageModifier)` BEFORE calling `super.destroy()`. Override `destroy()` method.

    **2. Create `src/game/entities/projectiles/FireballExplosion.js`:**

    Extends Entity. This is a VFX-only entity (no damage, no collision — that's Phase 4).

    Constructor: `{ x, y, damageModifier = 1.0 }`
    - Type: `'vfx-explosion'`
    - `this.maxRadius = 40 * (0.6 + 0.4 * damageModifier)` — sloppy = 24px, perfect = 40px
    - `this.currentRadius = 0`
    - `this.expansionSpeed = 150` px/sec
    - `this.lifetime = 400` (0.4 seconds)
    - `this.age = 0`
    - `this.damageModifier = damageModifier`
    - Color: '#ff6b35' (matches fireball)

    Update: increment age, expand radius via `expansionSpeed * dt`, destroy when age >= lifetime

    Render: additive blending
    - Outer expanding ring: strokeStyle orange with alpha fading from 1.0 to 0.0 over lifetime, lineWidth 3
    - Inner glow: fillStyle bright yellow (`#ffdf00`) at 60% * remaining alpha, radius = currentRadius * 0.5
    - shadowBlur = 12 for fiery glow

    Has `reset({ x, y, damageModifier })` method for pool reuse.

    **3. Update SpellCaster.js to handle Fireball explosions:**

    - Import FireballExplosion
    - Create `this.explosionPool = new ProjectilePool(FireballExplosion, 15)` in constructor
    - In `castSpell()`, when spawning a fireball, set the fireball's `onExpire` callback to spawn an explosion:
      ```javascript
      fireball.onExpire = (x, y, dm) => {
        const explosion = this.explosionPool.spawn({ x, y, damageModifier: dm });
        if (explosion) this.entityManager.add(explosion);
      };
      ```
    - Update `update(dt)` to also update the explosion pool
    - NOTE: Fireball explosions also trigger when fireballs leave the canvas (they get destroyed). But in that case, the explosion would be off-screen. To handle this cleanly: only trigger `onExpire` if the fireball is still within canvas bounds (check x/y against 0..canvasWidth, 0..canvasHeight). Add `setCanvasSize(w, h)` to store bounds if not already available from the SpellCaster's existing canvas size.

    **4. Enhance GestureUI accuracy feedback:**

    The GestureUI already shows "Perfect!/Great!/Good/Sloppy" with color coding. Enhance it to also display the spell name (from SPELL_CONFIG) instead of the raw gesture name:

    - Import SPELL_CONFIG into GestureUI.js
    - When `showResult(result)` is called, look up `SPELL_CONFIG[result.name]?.name` to get the display name ('Quick Shot', 'Magic Missile', 'Fireball')
    - If the gesture doesn't map to a spell (e.g., 'spiral'), fall back to displaying the raw gesture name
    - Display format: "QUICK SHOT" (spell name, top) then "Perfect! 95%" (quality + score, below)
  </action>
  <verify>
    - `npm run build` passes
    - Open game, draw a careful circle → large, bright cyan projectile with prominent glow
    - Draw a sloppy, messy circle → smaller, dimmer cyan projectile
    - Draw a zigzag → orange fireball flies, then explodes in an expanding orange ring with yellow center when it expires
    - Verify Magic Missile has a small tail trail behind it
    - GestureUI shows spell name (e.g., "QUICK SHOT") instead of raw gesture name ("CIRCLE")
    - Accuracy text still shows quality tier with correct colors
  </verify>
  <done>
    All projectile types render with accuracy-based visual scaling: sloppy draws produce visibly smaller/dimmer projectiles, perfect draws produce bright/full-size ones. Fireball creates an expanding AoE explosion VFX on expiry. Magic Missile has a distinctive tail trail. GestureUI displays spell names with accuracy feedback. Build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify spell casting experience</name>
  <what-built>
    Complete spell casting system: three spell types spawned by gesture recognition and keyboard shortcuts, with accuracy-based visual scaling and Fireball explosions.
  </what-built>
  <how-to-verify>
    1. Run `npm run dev` and navigate to the game canvas
    2. **Quick Shot (circle):** Draw a circle on the canvas. A cyan glowing projectile should fly outward from the shape's center in the direction you drew. It should disappear after ~3 seconds.
    3. **Magic Missile (triangle):** Draw a triangle. A light-cyan elongated projectile with a small trail should fly outward. Visually distinct from Quick Shot.
    4. **Fireball (zigzag):** Draw a zigzag pattern. An orange fireball should fly outward. When it expires or hits the screen edge, it should create an expanding ring explosion effect (orange ring + yellow center, fading over ~0.4 seconds).
    5. **Accuracy scaling:** Draw a very careful, clean circle. Note the projectile size and brightness. Then draw a very sloppy, messy circle. The sloppy one should look noticeably smaller and dimmer.
    6. **Keyboard fallback:** Press Q, W, E keys. Each should spawn the corresponding projectile at screen center, flying to the right.
    7. **Performance:** Rapidly cast 10+ spells. FPS should stay at 60 with no stuttering.
    8. **UI feedback:** After each cast, verify "QUICK SHOT" / "MAGIC MISSILE" / "FIREBALL" text appears at the top with accuracy quality text ("Perfect!", "Good", etc.)
    9. **All three spells should be visually distinct** (different color, shape, and size).
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with spell appearance, responsiveness, or visual quality</resume-signal>
</task>

</tasks>

<verification>
Phase 3 Success Criteria verification:
1. Drawing a circle spawns a Quick Shot projectile that travels along the drawn trajectory path ✓
2. Drawing a triangle spawns Magic Missile projectiles that travel along the trajectory ✓
3. Drawing a zigzag spawns a Fireball projectile with an AoE explosion visual at impact point ✓
4. Sloppy gesture draws produce visibly weaker spells (reduced size/brightness) with accuracy feedback text ✓
5. Spells are color-coded by tier (blue/cyan for free spells) and visually distinct from each other ✓
</verification>

<success_criteria>
- Sloppy gestures produce projectiles that are noticeably smaller and dimmer than perfect gestures
- Fireball explosion VFX plays on projectile expiry (expanding ring + fading center)
- GestureUI shows spell names with accuracy quality tiers
- All three spells are visually distinguishable in combat
- User approves the spell casting experience in checkpoint
- FPS maintained at 60 during spell casting
</success_criteria>

<output>
After completion, create `.planning/phases/03-spell-casting/03-02-SUMMARY.md`
</output>
