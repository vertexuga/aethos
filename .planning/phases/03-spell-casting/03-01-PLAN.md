---
phase: 03-spell-casting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/game/data/spellConfig.js
  - src/game/systems/ProjectilePool.js
  - src/game/entities/projectiles/QuickShotEntity.js
  - src/game/entities/projectiles/MagicMissileEntity.js
  - src/game/entities/projectiles/FireballEntity.js
  - src/game/systems/SpellCaster.js
  - src/game/engine/GameEngine.js
  - src/game/systems/KeyboardFallback.js
autonomous: true

must_haves:
  truths:
    - "Drawing a circle spawns a cyan Quick Shot projectile that travels outward from the drawn shape"
    - "Drawing a triangle spawns a light-cyan Magic Missile projectile that travels along the drawn trajectory"
    - "Drawing a zigzag spawns an orange Fireball projectile that travels along the drawn trajectory"
    - "Pressing Q/W/E on keyboard spawns the corresponding spell projectile at screen center"
    - "Projectiles move smoothly at configured speeds and auto-destroy after their lifetime expires"
    - "Projectile spawning happens within 1-2 frames of gesture completion (no perceptible delay)"
  artifacts:
    - path: "src/game/data/spellConfig.js"
      provides: "Centralized spell stats (speed, size, color, damage, lifetime) for all 3 spell types"
      exports: ["SPELL_CONFIG"]
    - path: "src/game/systems/ProjectilePool.js"
      provides: "Object pooling for projectile reuse to eliminate GC pauses"
      exports: ["default (ProjectilePool)"]
    - path: "src/game/entities/projectiles/QuickShotEntity.js"
      provides: "Circle gesture → fast cyan projectile with additive glow"
      exports: ["default (QuickShotEntity)"]
    - path: "src/game/entities/projectiles/MagicMissileEntity.js"
      provides: "Triangle gesture → elongated light-cyan projectile"
      exports: ["default (MagicMissileEntity)"]
    - path: "src/game/entities/projectiles/FireballEntity.js"
      provides: "Zigzag gesture → orange projectile"
      exports: ["default (FireballEntity)"]
    - path: "src/game/systems/SpellCaster.js"
      provides: "System that maps gesture results to projectile spawning via object pools"
      exports: ["default (SpellCaster)"]
  key_links:
    - from: "src/game/engine/GameEngine.js"
      to: "src/game/systems/SpellCaster.js"
      via: "handleGestureComplete() calls this.spellCaster.castSpell(result)"
      pattern: "spellCaster\\.castSpell"
    - from: "src/game/engine/GameEngine.js"
      to: "src/game/systems/SpellCaster.js"
      via: "update(dt) calls this.spellCaster.update(dt)"
      pattern: "spellCaster\\.update"
    - from: "src/game/systems/SpellCaster.js"
      to: "src/game/entities/EntityManager.js"
      via: "castSpell() adds spawned projectile to entityManager"
      pattern: "entityManager\\.add"
    - from: "src/game/systems/SpellCaster.js"
      to: "src/game/data/spellConfig.js"
      via: "Reads spell speed, size, color from SPELL_CONFIG"
      pattern: "SPELL_CONFIG"
    - from: "src/game/engine/GameEngine.js"
      to: "src/game/systems/KeyboardFallback.js"
      via: "handleKeyboardSpell() also calls spellCaster.castSpell(result)"
      pattern: "spellCaster\\.castSpell"
---

<objective>
Create the spell system infrastructure: spell configuration data, three projectile entity types (QuickShot, MagicMissile, Fireball), object pooling for projectile reuse, and the SpellCaster system that wires gesture recognition to projectile spawning.

Purpose: This is the core of Phase 3 -- when a player draws a shape or presses a keyboard shortcut, a spell projectile must appear immediately and fly across the screen. Without this, gesture recognition has no gameplay consequence.

Output: 7 new files (spellConfig.js, ProjectilePool.js, 3 projectile entities, SpellCaster.js) plus modifications to GameEngine.js and KeyboardFallback.js to wire spell casting into the game loop.
</objective>

<execution_context>
@/Users/johnsong/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsong/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-spell-casting/03-RESEARCH.md
@.planning/phases/02-gesture-recognition/02-02-SUMMARY.md

# Key source files to reference:
@src/game/entities/Entity.js
@src/game/entities/EntityManager.js
@src/game/engine/GameEngine.js
@src/game/systems/TrajectoryExtractor.js
@src/game/systems/KeyboardFallback.js
@src/game/data/gestureTemplates.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create spell config, projectile entities, and object pool</name>
  <files>
    src/game/data/spellConfig.js
    src/game/systems/ProjectilePool.js
    src/game/entities/projectiles/QuickShotEntity.js
    src/game/entities/projectiles/MagicMissileEntity.js
    src/game/entities/projectiles/FireballEntity.js
  </files>
  <action>
    **1. Create `src/game/data/spellConfig.js`** — centralized spell stats:

    ```javascript
    export const SPELL_CONFIG = {
      circle: {          // Quick Shot
        name: 'Quick Shot',
        speed: 400,       // px/sec (fastest)
        size: 6,          // base radius in px
        color: '#4dd0e1', // Cyan (free tier)
        baseDamage: 10,
        lifetime: 3000,   // ms
        manaCost: 0,      // Free tier
        tier: 'free'
      },
      triangle: {        // Magic Missile
        name: 'Magic Missile',
        speed: 250,       // px/sec (medium - needs time to aim)
        size: 5,
        color: '#80deea', // Light cyan (free tier)
        baseDamage: 8,
        lifetime: 4000,   // ms (longer for homing)
        manaCost: 0,
        tier: 'free'
      },
      zigzag: {          // Fireball
        name: 'Fireball',
        speed: 300,       // px/sec
        size: 8,          // bigger than others
        color: '#ff6b35', // Orange (visually distinct)
        baseDamage: 15,
        lifetime: 3000,   // ms
        manaCost: 0,
        tier: 'free',
        explosionRadius: 40 // AoE radius in px
      }
    };
    ```

    The color scheme: Quick Shot (#4dd0e1 cyan), Magic Missile (#80deea light cyan), Fireball (#ff6b35 orange). These must be visually distinct against the dark #0a0a12 background. Fireball intentionally breaks the cyan free-tier convention because it's an AoE spell that players need to distinguish at a glance.

    **2. Create `src/game/systems/ProjectilePool.js`** — object pool for GC-free projectile reuse:

    The pool pre-allocates projectile instances. On `spawn()`, it pops an inactive entity from the pool, resets its properties, and marks it active. On `release()`, it deactivates and returns to pool. The `update(dt)` method iterates active projectiles, auto-releasing those that are no longer active (destroyed via lifetime).

    Key implementation details:
    - Constructor takes `EntityClass` and `poolSize` (default 30)
    - Pre-allocate `poolSize` entities with zeroed properties, all `active = false`
    - `spawn({ x, y, vx, vy, damageModifier })` resets entity properties and marks `active = true`
    - When calling `spawn()`, also reset `age = 0` on the entity
    - `release(projectile)` sets `active = false` and returns to pool
    - `update(dt)` iterates backwards over `active` array, releasing inactive ones
    - Fallback: if pool exhausted, create a new entity (log warning to console)
    - `getActive()` returns array of currently active projectiles

    **3. Create `src/game/entities/projectiles/` directory** (mkdir -p) with three entity classes:

    **QuickShotEntity.js** — extends Entity:
    - Constructor: reads speed/size/color/baseDamage/lifetime from SPELL_CONFIG.circle
    - Accepts `{ x, y, vx, vy, damageModifier }` in constructor
    - Type: `'projectile-quickshot'`
    - `update(dt)`: calls `super.update(dt)` for velocity movement, increments `this.age += dt * 1000`, destroys self when `age >= lifetime`
    - `render(ctx)`: Uses `globalCompositeOperation = 'lighter'` for additive glow. Draw a filled circle at (x, y) with `this.size` radius. Use `shadowBlur = 8` and `shadowColor = this.color`. Restore ctx after.
    - `getDamage()`: returns `baseDamage * damageModifier`
    - `reset({ x, y, vx, vy, damageModifier })`: method for pool reuse — sets all properties and resets `age = 0`, `active = true`

    **MagicMissileEntity.js** — extends Entity:
    - Constructor: reads from SPELL_CONFIG.triangle
    - Type: `'projectile-magicmissile'`
    - Stores `this.speed = SPELL_CONFIG.triangle.speed` for future homing (Phase 4)
    - `update(dt)`: calls `super.update(dt)`, increments age, destroys on lifetime. NOTE: In Phase 3, no homing behavior (no enemies exist). Just flies straight along trajectory. Phase 4 will add `findNearestTarget()` and angle interpolation.
    - `render(ctx)`: additive blending. Draw an ELONGATED ellipse in the direction of travel. Calculate angle from `Math.atan2(vy, vx)`, translate+rotate ctx, draw `ctx.ellipse(0, 0, size * 1.5, size * 0.6, ...)`. This makes it visually distinct from QuickShot's circle.
    - Has `reset()` method like QuickShot.

    **FireballEntity.js** — extends Entity:
    - Constructor: reads from SPELL_CONFIG.zigzag
    - Type: `'projectile-fireball'`
    - `update(dt)`: calls `super.update(dt)`, increments age, destroys on lifetime
    - `render(ctx)`: additive blending. Draw a larger filled circle with a secondary inner glow (two concentric circles — outer orange, inner bright yellow at 60% alpha). shadowBlur = 12 (bigger glow than QuickShot).
    - Has `reset()` method like QuickShot.
    - NOTE: AoE explosion on "impact" will be added in Plan 03-02 (no collision targets in Phase 3 yet).

    **Critical: All three entity classes must import from `'../Entity.js'` (one level up from projectiles/ directory) and import SPELL_CONFIG from `'../../data/spellConfig.js'`.**
  </action>
  <verify>
    - `ls src/game/data/spellConfig.js` exists
    - `ls src/game/systems/ProjectilePool.js` exists
    - `ls src/game/entities/projectiles/QuickShotEntity.js` exists
    - `ls src/game/entities/projectiles/MagicMissileEntity.js` exists
    - `ls src/game/entities/projectiles/FireballEntity.js` exists
    - `npm run build` succeeds (no import errors, no syntax errors)
  </verify>
  <done>
    All 5 files exist. spellConfig.js exports SPELL_CONFIG with circle/triangle/zigzag spell definitions. ProjectilePool provides spawn/release/update cycle. Three projectile entities extend Entity with spell-specific render styles (circle glow, elongated ellipse, large fireball with inner glow). All use additive blending via globalCompositeOperation 'lighter'. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SpellCaster system and wire into GameEngine</name>
  <files>
    src/game/systems/SpellCaster.js
    src/game/engine/GameEngine.js
    src/game/systems/KeyboardFallback.js
  </files>
  <action>
    **1. Create `src/game/systems/SpellCaster.js`** — the central system that converts gesture results into projectile entities:

    ```javascript
    import ProjectilePool from './ProjectilePool.js';
    import QuickShotEntity from '../entities/projectiles/QuickShotEntity.js';
    import MagicMissileEntity from '../entities/projectiles/MagicMissileEntity.js';
    import FireballEntity from '../entities/projectiles/FireballEntity.js';
    import { SPELL_CONFIG } from '../data/spellConfig.js';
    ```

    Constructor receives `entityManager` reference. Creates 3 pools:
    - `this.quickShotPool = new ProjectilePool(QuickShotEntity, 30)`
    - `this.magicMissilePool = new ProjectilePool(MagicMissileEntity, 30)`
    - `this.fireballPool = new ProjectilePool(FireballEntity, 20)`

    **`castSpell(gestureResult)`:**
    - Extract `{ name, damageModifier, trajectory }` from gestureResult
    - If no trajectory AND not fromKeyboard: return (no direction to fire). For keyboard casts without trajectory, use a default direction (aim right: `{ direction: { x: 1, y: 0 }, origin: { x: canvasWidth/2, y: canvasHeight/2 } }`). Store canvas dimensions via a `setCanvasSize(w, h)` method called from GameEngine.
    - Look up spell config: `const config = SPELL_CONFIG[name]`
    - If no config found (unrecognized gesture like 'spiral', 'star', etc that aren't mapped to spells yet): return silently
    - Calculate velocity: `vx = trajectory.direction.x * config.speed`, `vy = trajectory.direction.y * config.speed`
    - Spawn from appropriate pool based on `name`:
      - `'circle'` → quickShotPool
      - `'triangle'` → magicMissilePool
      - `'zigzag'` → fireballPool
    - Add spawned projectile to `this.entityManager.add(projectile)`

    **`update(dt)`:** Update all 3 pools (which handle auto-releasing expired projectiles)

    **`getActiveCount()`:** Sum of all pool active counts (useful for debugging)

    **2. Modify `src/game/engine/GameEngine.js`:**

    Add import for SpellCaster:
    ```javascript
    import SpellCaster from '../systems/SpellCaster.js';
    ```

    In `init()`:
    - After creating entityManager, create SpellCaster: `this.spellCaster = new SpellCaster(this.entityManager);`
    - Set canvas size: `this.spellCaster.setCanvasSize(this.width, this.height);`
    - Remove the 5 test entity spawning code (the for loop that creates random bouncing circles). These were Phase 1 test objects no longer needed.

    In `handleGestureComplete(points)`:
    - After `this.gestureUI.showResult(result)` and `this.inputSystem.setRecognitionResult(result)`, add:
    - `this.spellCaster.castSpell(result);`
    - This is CRITICAL: the spellCaster.castSpell() must be called in the SAME function as gesture recognition, not deferred to next tick. This meets the 1-2 frame latency requirement.

    In `handleKeyboardSpell(result)`:
    - Add `this.spellCaster.castSpell(result);` after the existing Zustand/UI feedback code
    - Keyboard spells won't have a trajectory property, so SpellCaster uses the default direction (aim right from screen center).

    In `update(dt)`:
    - Add `this.spellCaster.update(dt);` BEFORE the entityManager.update(dt) call (so pool cleanup runs before entity manager cleanup)
    - Keep the boundary wrapping code but change it: instead of wrapping projectiles, DESTROY projectiles that leave the canvas bounds (wrapping makes no sense for spells). Check entity.type — if it starts with 'projectile-', destroy it when out of bounds instead of wrapping. Non-projectile entities still wrap.

    In `resize()`:
    - After updating width/height, call `this.spellCaster?.setCanvasSize(this.width, this.height);`

    In `destroy()`:
    - Add `this.spellCaster = null;` cleanup

    **3. Modify `src/game/systems/KeyboardFallback.js`:**

    The keyboard mapping currently maps 'e'/'E' to 'line'. But the roadmap says zigzag = Fireball. For Phase 3 spell casting:
    - Change 'e'/'E' mapping from 'line' to 'zigzag' so pressing E fires a Fireball (which is the zigzag gesture)
    - This aligns Q = circle (Quick Shot), W = triangle (Magic Missile), E = zigzag (Fireball)
  </action>
  <verify>
    - `npm run build` succeeds
    - Open the game in browser (npm run dev), draw a circle on the canvas → a cyan glowing projectile should fly outward from the shape's center
    - Draw a triangle → an elongated light-cyan projectile flies outward
    - Draw a zigzag → an orange glowing projectile flies outward
    - Press Q → cyan projectile appears at screen center and flies right
    - Press W → light-cyan projectile appears at screen center and flies right
    - Press E → orange projectile appears at screen center and flies right
    - Projectiles disappear after a few seconds (lifetime expiry)
    - No console errors
    - FPS stays at 60 during rapid casting
  </verify>
  <done>
    SpellCaster system exists and is wired into GameEngine. Drawing a recognized gesture (circle/triangle/zigzag) immediately spawns the corresponding projectile at the gesture's center, flying along the drawn trajectory. Keyboard shortcuts Q/W/E spawn projectiles at screen center. Projectiles use object pooling (no GC pauses). Projectiles auto-destroy on lifetime expiry or leaving canvas bounds. Test entities removed. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no errors or warnings
2. Draw circle → cyan Quick Shot projectile spawns immediately and flies outward
3. Draw triangle → light-cyan Magic Missile projectile spawns and flies outward (elongated shape)
4. Draw zigzag → orange Fireball projectile spawns and flies outward (larger with inner glow)
5. Press Q/W/E → corresponding projectile spawns at screen center
6. Projectiles auto-destroy after 3-4 seconds
7. Projectiles destroy when leaving canvas bounds (not wrapping)
8. FPS stays at 60 during rapid-fire casting
9. No GC pauses visible in Chrome DevTools Performance tab
10. Console shows no errors or warnings (except debug logging)
</verification>

<success_criteria>
- Three visually distinct spell projectiles spawn from gesture recognition
- Projectile spawn latency under 2 frames (~33ms) from gesture completion
- Object pooling prevents garbage collection pauses
- Keyboard fallback casts spells (not just shows UI feedback)
- Build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-spell-casting/03-01-SUMMARY.md`
</output>
